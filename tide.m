function [dc, ds, dc0] = tide(r_Sun, r_Moon, JD1, JD2, HG)
% DESCRIPTION:     Calculate tide coefficients.
% AUTHOR:          ZhangLei
% EMAIL:           the.lei@qq.com
% LAST MODIFIED:   2024-05-15
% VERSION:         1.0
    klove = zeros(4,4); % klove(n+1, m+1)
    klove(2+1,0+1) = 0.29525;
    klove(2+1,1+1) = 0.29470;
    klove(2+1,2+1) = 0.29801;
    klove(3+1,0+1) = 0.093;
    klove(3+1,1+1) = 0.093;
    klove(3+1,2+1) = 0.093;
    klove(3+1,3+1) = 0.094;

    klovep = zeros(3); % klovep(n+1)
    klovep(0+1)  = -0.00087;
    klovep(1+1)  = -0.00079;
    klovep(2+1)  = -0.00057;
    
    rad2arcsec = 206264.8062470963551564734;

%     global EOPmat
%     mjd_day = floor(jd - 2400000.5);
%     xp = EOPmat(EOPmat(:,1)==mjd_day,2) / 3600 * pi / 180;         % radians
%     yp = EOPmat(EOPmat(:,1)==mjd_day,3) / 3600 * pi / 180;         % radians
%     UT1_UTC = EOPmat(EOPmat(:,1)==mjd_day,4) / 86400;  
    eop = TOOL_geteop(JD1-2400000.5+JD2);
    xp = eop.xp;
    yp = eop.yp;
    UT1_UTC = eop.UT1_UTC;
    dX = eop.dX;
    dY = eop.dY;
    
    UT11 = JD1;
    UT12 = JD2 + UT1_UTC;
    JDTT1 = JD1;
    JDTT2 = JD2 + 69.184/86400;

%     [dpsi, deps] = iauNut06a(JDTT, 0);
%     M = iauPn06(JDTT, 0, dpsi, deps);
%     gst = iauGst06(UT1, 0, JDTT, 0.0, M);

    [dpsi, deps] = iauNut00a_mex(JDTT1, JDTT2);
    [epsa, ~, ~, ~, ~, rbpn] = iauPn00(JDTT1, JDTT2, dpsi, deps);
    
    % /* Transform dX,dY corrections from GCRS to mean of date. */
    v2 = rbpn * [dX; dY; 0];
    ddpsi = v2(1) / sin(epsa);
%     ddeps = v2(2);
    dpsi = dpsi + ddpsi;
%     deps = deps + ddeps;
    gst = iauAnp ( iauGmst00 ( UT11, UT12, JDTT1, JDTT2 ) + iauEe00 ( JDTT1, JDTT2, epsa, dpsi ) );
    
    beta = sdfa_beta(JDTT1, JDTT2, gst);
    
    GM_sun = 1.327122e20;
    GM_Moon = 4.9028029535968e12;
    GM = 3.9860044150E+14;
    Re = 6.37813630E+06;
    
%     HG = sofa_C2T(jd);
    r_Sun_ITRS = HG * r_Sun;
    r_Moon_ITRS = HG * r_Moon;
    
    [lam_Sun, sphi_Sun, ~] = d2l(r_Sun_ITRS(1), r_Sun_ITRS(2), r_Sun_ITRS(3));
    [lam_Moon, sphi_Moon, ~] = d2l(r_Moon_ITRS(1), r_Moon_ITRS(2), r_Moon_ITRS(3));
 
    [p_Sun0, ~] = average_Pl_u_mex(sphi_Sun, 3);
    [p_Moon0, ~] = average_Pl_u_mex(sphi_Moon, 3);
    [p_Sun, ~] = average_Plm_u_mex(sphi_Sun, 3);
    [p_Moon, ~] = average_Plm_u_mex(sphi_Moon, 3);
    
    global clm0
    gorder = size(clm0, 2);
    dc = zeros(gorder, gorder);
    ds = zeros(gorder, gorder);
    dc0 = zeros(gorder, 1);
    
    for n = 2:3
        for m = 0:n
            if m == 0
                dc0(n) = klove(n+1, m+1) / (2*n+1) * ((GM_Moon / GM) * (Re / norm(r_Moon_ITRS))^(n+1) * p_Moon0(n+1) * cos(m*lam_Moon) ...
                    + (GM_sun / GM) * (Re / norm(r_Sun_ITRS))^(n+1) * p_Sun0(n+1) * cos(m*lam_Sun)) + dc0(n);
            else  
                dc(n,m) = klove(n+1, m+1) / (2*n+1) * ((GM_Moon / GM) * (Re / norm(r_Moon_ITRS))^(n+1) * p_Moon(n,m) * cos(m*lam_Moon) ...
                    + (GM_sun / GM) * (Re / norm(r_Sun_ITRS))^(n+1) * p_Sun(n,m) * cos(m*lam_Sun)) + dc(n,m);
                ds(n,m) = klove(n+1, m+1) / (2*n+1) * ((GM_Moon / GM) * (Re / norm(r_Moon_ITRS))^(n+1) * p_Moon(n,m) * sin(m*lam_Moon) ...
                    + (GM_sun / GM) * (Re / norm(r_Sun_ITRS))^(n+1) * p_Sun(n,m) * sin(m*lam_Sun)) + ds(n,m);
            end
        end
    end
    
    % n = 4
    for m = 0:2
        if m == 0
            dc0(4) = klovep(m+1) / 5 * ((GM_Moon / GM) * (Re / norm(r_Moon_ITRS))^3 * p_Moon0(2+1) * cos(m*lam_Moon) ...
                + (GM_sun / GM) * (Re / norm(r_Sun_ITRS))^3 * p_Sun0(2+1) * cos(m*lam_Sun)) + dc(4);
        else
            dc(4,m) = klovep(m+1) / 5 * ((GM_Moon / GM) * (Re / norm(r_Moon_ITRS))^3 * p_Moon(2,m) * cos(m*lam_Moon) ...
                + (GM_sun / GM) * (Re / norm(r_Sun_ITRS))^3 * p_Sun(2,m) * cos(m*lam_Sun)) + dc(4,m);
            ds(4,m) = klovep(m+1) / 5 * ((GM_Moon / GM) * (Re / norm(r_Moon_ITRS))^3 * p_Moon(2,m) * sin(m*lam_Moon) ...
                + (GM_sun / GM) * (Re / norm(r_Sun_ITRS))^3 * p_Sun(2,m) * sin(m*lam_Sun)) + ds(4,m);
        end
    end
    
    % n = 2, m = 1 的修正项
    table65a = [12.85429 125,755 1 -3 0 2 0 0 2 0 2 0 2 -29 3 -0.1 0.0;
                12.92714 127,555 1 -3 2 0 0 0 0 0 2 2 2 -30 3 -0.1 0.0;
                13.39645 135,645 1 -2 0 1 -1 0 1 0 2 0 1 -45 5 -0.1 0.0;
                13.39866 135,655 1 -2 0 1 0 0 1 0 2 0 2 -46 5 -0.7 0.1;
                13.47151 137,455 1 -2 2 -1 0 0 -1 0 2 2 2 -49 5 -0.1 0.0;
                13.94083 145,545 1 -1 0 0 -1 0 0 0 2 0 1 -82 7 -1.3 0.1;
                13.94303 145,555 1 -1 0 0 0 0 0 0 2 0 2 -83 7 -6.8 0.6;
                14.02517 147,555 1 -1 2 0 0 0 0 0 0 2 0 -91 9 0.1 0.0;
                14.41456 153,655 1 0 -2 1 0 0 1 0 2 -2 2 -168 14 0.1 0.0;
                14.48520 155,445 1 0 0 -1 -1 0 -1 0 2 0 1 -193 16 0.1 0.0;
                14.48741 155,455 1 0 0 -1 0 0 -1 0 2 0 2 -194 16 0.4 0.0;
                14.49669 155,655 1 0 0 1 0 0 1 0 0 0 0 -197 16 1.3 -0.1;
                14.49890 155,665 1 0 0 1 1 0 1 0 0 0 1 -198 16 0.3 0.0;
                14.56955 157,455 1 0 2 -1 0 0 -1 0 0 2 0 -231 18 0.3 0.0;
                14.57176 157,465 1 0 2 -1 1 0 -1 0 0 2 1 -233 18 0.1 0.0;
                14.91787 162,556 1 1 -3 0 0 1 0 1 2 -2 2 -834 58 -1.9 0.1;
                14.95673 163,545 1 1 -2 0 -1 0 0 0 2 -2 1 -1117 76 0.5 0.0;
                14.95893 163,555 1 1 -2 0 0 0 0 0 2 -2 2 -1138 77 -43.4 2.9;
                15.00000 164,554 1 1 -1 0 0 -1 0 -1 2 -2 2 -1764 104 0.6 0.0;
                15.00000 164,556 1 1 -1 0 0 1 0 1 0 0 0 -1764 104 1.6 -0.1;
                15.02958 165,345 1 1 0 -2 -1 0 -2 0 2 0 1 -3048 92 0.1 0.0;
                15.03665 165,535 1 1 0 0 -2 0 0 0 0 0 -2 -3630 195 0.1 0.0;
                15.03886 165,545 1 1 0 0 -1 0 0 0 0 0 -1 -3845 229 -8.8 0.5;
                15.04107 165,555 1 1 0 0 0 0 0 0 0 0 0 -4084 262 470.9 -30.2;
                15.04328 165,565 1 1 0 0 1 0 0 0 0 0 1 -4355 297 68.1 -4.6;
                15.04548 165,575 1 1 0 0 2 0 0 0 0 0 2 -4665 334 -1.6 0.1;
                15.07749 166,455 1 1 1 -1 0 0 -1 0 0 1 0 85693 21013 0.1 0.0;
                15.07993 166,544 1 1 1 0 -1 -1 0 -1 0 0 -1 35203 2084 -0.1 0.0;
                15.08214 166,554 1 1 1 0 0 -1 0 -1 0 0 0 22794 358 -20.6 -0.3;
                15.08214 166,556 1 1 1 0 0 1 0 1 -2 2 -2 22780 358 0.3 0.0;
                15.08434 166,564 1 1 1 0 1 -1 0 -1 0 0 1 16842 -85 -0.3 0.0;
                15.11392 167,355 1 1 2 -2 0 0 -2 0 0 2 0 3755 -189 -0.2 0.0;
                15.11613 167,365 1 1 2 -2 1 0 -2 0 0 2 1 3552 -182 -0.1 0.0;
                15.12321 167,555 1 1 2 0 0 0 0 0 -2 2 -2 3025 -160 -5.0 0.3;
                15.12542 167,565 1 1 2 0 1 0 0 0 -2 2 -1 2892 -154 0.2 0.0;
                15.16427 168,554 1 1 3 0 0 -1 0 -1 -2 2 -2 1638 -93 -0.2 0.0;
                15.51259 173,655 1 2 -2 1 0 0 1 0 0 -2 0 370 -20 -0.5 0.0;
                15.51480 173,665 1 2 -2 1 1 0 1 0 0 -2 1 369 -20 -0.1 0.0;
                15.58323 175,445 1 2 0 -1 -1 0 -1 0 0 0 -1 325 -17 0.1 0.0;
                15.58545 175,455 1 2 0 -1 0 0 -1 0 0 0 0 324 -17 -2.1 0.1;
                15.58765 175,465 1 2 0 -1 1 0 -1 0 0 0 1 323 -16 -0.4 0.0;
                16.05697 183,555 1 3 -2 0 0 0 0 0 0 -2 0 194 -8 -0.2 0.0;
                16.12989 185,355 1 3 0 -2 0 0 -2 0 0 0 0 185 -7 -0.1 0.0;
                16.13911 185,555 1 3 0 0 0 0 0 0 -2 0 -2 184 -7 -0.6 0.0;
                16.14131 185,565 1 3 0 0 1 0 0 0 -2 0 -1 184 -7 -0.4 0.0;
                16.14352 185,575 1 3 0 0 2 0 0 0 -2 0 0 184 -7 -0.1 0.0;
                16.68348 195,455 1 4 0 -1 0 0 -1 0 -2 0 -2 141 -4 -0.1 0.0;
                16.68569 195,465 1 4 0 -1 1 0 -1 0 -2 0 -1 141 -4 -0.1 0.0];
            
    theta_f = table65a(:,3:8) * beta;
    aip = table65a(:,17)' * 1e-12;
    aop = table65a(:,18)' * 1e-12;
    dc(2,1) = dc(2,1) + aop * cos(theta_f) + aip * sin(theta_f);
    ds(2,1) = ds(2,1) + aip * cos(theta_f) - aop * sin(theta_f);
    
    % 极潮
    [xpmean, ypmean] = meanpole(JDTT1, JDTT2);
    
    m1 = xp * rad2arcsec - xpmean;
    m2 = -(yp * rad2arcsec - ypmean);
    
    dc(2,1) = dc(2,1) - 1.333e-9 * (m1 + 0.0115 * m2);
    ds(2,1) = ds(2,1) - 1.333e-9 * (m2 - 0.0115 * m1);
    dc(2,1) = dc(2,1) - 2.1778e-10 * (m1 - 0.01724 * m2);
    ds(2,1) = ds(2,1) - 1.7232e-10 * (m2 - 0.03365 * m1);
    
    % 海潮
    global fes2004
    
    oceantab = fes2004(:,2:3);
    oceantab(:,3) = fes2004(:,8:13) * beta;  % theta_f
    oceantab(:,4) = (fes2004(:,4) .* cos(oceantab(:,3)) + fes2004(:,5) .* sin(oceantab(:,3)) ...
        + fes2004(:,6) .* cos(oceantab(:,3)) + fes2004(:,7) .* sin(oceantab(:,3))) * 1e-11; % dc
    oceantab(:,5) = (-fes2004(:,4) .* sin(oceantab(:,3)) + fes2004(:,5) .* cos(oceantab(:,3)) ...
        + fes2004(:,6) .* sin(oceantab(:,3)) - fes2004(:,7) .* cos(oceantab(:,3))) * 1e-11; % ds
    
    for i = 1:1302
        l = oceantab(i,1);
        dc0(l) = dc0(l) + oceantab(i,4);
    end
    for i = 1303:59452
        l = oceantab(i,1);
        m = oceantab(i,2);
        dc(l,m) = dc(l,m) + oceantab(i,4);
        ds(l,m) = ds(l,m) + oceantab(i,5);
    end
% 
%     % 提取第一部分数据
%     l1 = oceantab(1:1302, 1);
%     dc0 = accumarray(l1, oceantab(1:1302, 4));
% 
%     % 提取第二部分数据
%     l2 = oceantab(1303:59452, 1);
%     m2 = oceantab(1303:59452, 2);
%     dc = accumarray([l2, m2], oceantab(1303:59452, 4));
%     ds = accumarray([l2, m2], oceantab(1303:59452, 5));


%     rdist = [10,16,18,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,16,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10];
%     oceancell = mat2cell(oceantab, rdist);
%     sum_oceancell = cellfun(@(x) sum(x(:,4:5)), oceancell, 'UniformOutput', false);
%     mean_oceancell = cellfun(@(x) mean(x(:,1:2)), oceancell, 'UniformOutput', false);
%     oceanmat = [cell2mat(mean_oceancell) cell2mat(sum_oceancell)];
%     dc0 = dc0 + oceanmat(2:101, 4);
%     dc = dc + sparse(oceanmat(102:end,1),oceanmat(102:end,2),oceanmat(102:end,3));
%     ds = ds + sparse(oceanmat(102:end,1),oceanmat(102:end,2),oceanmat(102:end,4));

%     for i = 1:59462
%         l = oceantab(i,1);
%         m = oceantab(i,2);
%         if m == 0
%             if l == 0
%                 continue
%             end
%             dc0(l) = dc0(l) + oceantab(i,4);
%         else
%             dc(l,m) = dc(l,m) + oceantab(i,4);
%             ds(l,m) = ds(l,m) + oceantab(i,5);
%         end
%     end
end

function [xpmean, ypmean] = meanpole(JDTT1, JDTT2)
    dtyear = (JDTT1 - 2451544.5 + JDTT2) / 365.25;
    
    if JDTT1 > 2.4551975e+06
        xpmean =  23.513+7.6141*dtyear;
        ypmean = 358.891-0.6287*dtyear;
    else
        xpmean = 55.974+dtyear*(1.8243+dtyear*( 0.18413+dtyear*  0.007024));
        ypmean =346.346+dtyear*(1.7896+dtyear*(-0.10729+dtyear*(-0.000908)));
    end
    xpmean = xpmean*1e-3;
    ypmean = ypmean*1e-3;
end

function NPB = iauPn06(date1, date2, dpsi, deps)
    % Bias-precession Fukushima-Williams angles of date.
    [gamb, phib, psib, eps] = iauPfw06(date1, date2);
    
    % BPN = Rz(gamb) * Rx(phib) * Rz(-(psib + dpsi)) * Rx(-(eps + deps));
    NPB = Rx(-(eps + deps)) * Rz(-(psib + dpsi)) * Rx(phib) * Rz(gamb);
end

function [gamb, phib, psib, eps] = iauPfw06(date1, date2)
    DJ00 = 2451545.0;
    DJC = 36525.0;
    
    % Arcseconds to radians
    DAS2R = 4.848136811095359935899141e-6;
    
    % Interval between fundamental date J2000.0 and given date (JC). 
    t = ((date1 - DJ00) + date2) / DJC;
    
    % P03 bias+precession angles.
    gamb = (    -0.052928     + ...
           (    10.556378     + ...
           (     0.4932044    + ...
           (    -0.00031238   + ...
           (    -0.000002788  + ...
           (     0.0000000260 ) ...
           * t) * t) * t) * t) * t) * DAS2R;
    phib = ( 84381.412819     + ...
           (   -46.811016     + ...
           (     0.0511268    + ...
           (     0.00053289   + ...
           (    -0.000000440  + ...
           (    -0.0000000176 ) ...
           * t) * t) * t) * t) * t) * DAS2R;
    psib = (    -0.041775     + ...
           (  5038.481484     + ...
           (     1.5584175    + ...
           (    -0.00018522   + ...
           (    -0.000026452  + ...
           (    -0.0000000148 ) ...
           * t) * t) * t) * t) * t) * DAS2R;
    eps = (84381.406     + ...
          (-46.836769    + ...
          ( -0.0001831   + ...
          (  0.00200340  + ...
          ( -0.000000576 + ...
          ( -0.0000000434) * t) * t) * t) * t) * t) * DAS2R; 
end

function GST = iauGst06(uta, utb, tta, ttb, NPB)
    % Extract CIP coordinates.
    x = NPB(3,1);
    y = NPB(3,2);
    
    % The CIO locator, s.
    s = iauS06(tta, ttb, x, y);
    
    % Greenwich apparent sidereal time.
    era = iauEra00(uta, utb);
    eors = iauEors(NPB, s);
    gst_temp = era - eors;
    GST = rem(gst_temp, 2*pi);
    if (GST < 0) 
       GST = GST + 2*pi;
    end
end

function theta = iauEra00(dj1, dj2)
    DJ00 = 2451545.0;
    D2PI = 2 * pi;
    
    % Days since fundamental epoch.
    if (dj1 < dj2) 
      d1 = dj1;
      d2 = dj2;
    else 
      d1 = dj2;
      d2 = dj1;
    end
    t = d1 + (d2- DJ00);
    
    % Fractional part of T (days).
    f = rem(d1, 1.0) + rem(d2, 1.0);
    
    % Earth rotation angle at this UT1.
    theta_temp = (D2PI * (f + 0.7790572732640 ...
                            + 0.00273781191135448 * t));
                        
    theta = rem(theta_temp, D2PI);
    if (theta < 0) 
        theta = theta + D2PI;
    end
end

function eo = iauEors(NPB, s)
    % Evaluate Wallace & Capitaine (2006) expression (16). */
    x = NPB(3,1);
    ax = x / (1.0 + NPB(3,3));
    xs = 1.0 - ax * x;
    ys = -ax * NPB(3,2);
    zs = -x;
    p = NPB(1,1) * xs + NPB(1,2) * ys + NPB(1,3) * zs;
    q = NPB(2,1) * xs + NPB(2,2) * ys + NPB(2,3) * zs;
    if (p ~= 0) || (q ~= 0)
        eo = s - atan2(q, p);
    else
        eo = s;
    end
end

function beta = sdfa_beta(JDTT1, JDTT2, gst)
    % Doodson's fundamental arguments 天文参数
    
    beta = zeros(6,1);
    [fnut] = faont(JDTT1, JDTT2);
    
    beta(2) = fnut(3)+fnut(5);
    beta(3) = beta(2)-fnut(4);
    beta(4) = beta(2)-fnut(1);
    beta(5) = -fnut(5);
    beta(6) = beta(2)-fnut(4)-fnut(2);
    beta(1) = gst+pi-beta(2);
end

function [fa] = faont(date1, date2)
    DJ00 = 2451545.0;
    DJC = 36525.0;
    
    % Arcseconds to radians
    DAS2R = 4.848136811095359935899141e-6;
    % Arcseconds in a full circle
    TURNAS = 1296000.0;
    
    % Interval between fundamental date J2000.0 and given date (JC). 
    t = ((date1 - DJ00) + date2) / DJC;
    
    fa = zeros(5,1);
    
    % Mean anomaly of the Moon.
    fa(1) = rem(           485868.249036  + ...
             t * ( 1717915923.2178 + ...
             t * (         31.8792 + ...
             t * (          0.051635 + ...
             t * (        - 0.00024470 ) ) ) ), TURNAS ) * DAS2R;

    % Mean anomaly of the Sun.
    fa(2) = rem(         1287104.793048 + ...
             t * ( 129596581.0481 + ...
             t * (       - 0.5532 + ...
             t * (         0.000136 + ...
             t * (       - 0.00001149 ) ) ) ), TURNAS ) * DAS2R;

    % Mean longitude of the Moon minus that of the ascending node.
    fa(3) = rem(           335779.526232 + ...
             t * ( 1739527262.8478 + ...
             t * (       - 12.7512 + ...
             t * (        - 0.001037 + ...
             t * (          0.00000417 ) ) ) ), TURNAS ) * DAS2R;

    % Mean elongation of the Moon from the Sun. 
    fa(4) = rem(          1072260.703692 + ...
             t * ( 1602961601.2090 + ...
             t * (        - 6.3706 + ...
             t * (          0.006593 + ...
             t * (        - 0.00003169 ) ) ) ), TURNAS ) * DAS2R;

    % Mean longitude of the ascending node of the Moon. 
    fa(5) = rem(          450160.398036 + ...
             t * ( - 6962890.5431 + ...
             t * (         7.4722 + ...
             t * (         0.007702 + ...
             t * (       - 0.00005939 ) ) ) ), TURNAS ) * DAS2R;
end

function C = Rx(theta)
C = [   1              0               0;
        0          cos(theta)      sin(theta);
        0          -sin(theta)     cos(theta)];
end

% function C = Ry(theta)
% C = [cos(theta)         0           -sin(theta);
%         0               1               0;
%      sin(theta)         0           cos(theta)];
% end

function C = Rz(theta)
C = [cos(theta)     sin(theta)          0;
     -sin(theta)    cos(theta)          0;
        0               0               1];
end